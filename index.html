<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseReport - CATTO</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>CaseReport - CATTO</h1>
            <p class="subtitle">Anesthesia Case Report Screening AI</p>
        </header>

        <!-- API Key Section -->
        <section class="glass-panel" id="apiKeySection">
            <h3>🔑 Gemini API Key</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                このアプリケーションを使用するには、Google Gemini APIキーが必要です。
                <a href="https://aistudio.google.com/apikey" target="_blank"
                    style="color: var(--secondary);">こちら</a>から取得できます。
            </p>
            <div style="display: flex; gap: 1rem; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="apiKeyInput">APIキーを入力</label>
                    <input type="password" id="apiKeyInput" placeholder="AIzaSy...">
                </div>
                <button onclick="saveApiKey()" class="btn btn-primary">保存</button>
            </div>
            <p id="apiKeyStatus" style="margin-top: 0.5rem; font-size: 0.85rem;"></p>
        </section>

        <section class="glass-panel" id="formSection" style="display:none;">
            <form id="cattoForm" class="grid">

                <!-- Email -->
                <div class="form-section">
                    <label for="submitter_email">Your Email (for Report)</label>
                    <input type="email" id="submitter_email" name="submitter_email"
                        placeholder="e.g. doctor@hospital.com" required>
                </div>

                <!-- A. Main Event -->
                <div>
                    <label for="main_event_1line">A. Main Event (1 line description)</label>
                    <input type="text" id="main_event_1line" name="main_event_1line"
                        placeholder="e.g. Rupture of left Valsalva sinus immediately after CPB..." required>
                </div>

                <div class="grid-2">
                    <div>
                        <label for="condition_event">B. Condition / Event</label>
                        <input type="text" id="condition_event" name="condition_event"
                            placeholder="Medical term & synonyms" required>
                    </div>
                    <div>
                        <label for="anatomy">C. Anatomy</label>
                        <input type="text" id="anatomy" name="anatomy" placeholder="Site, Side, Related structures"
                            required>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label for="trigger_exposure">D. Trigger / Exposure</label>
                        <input type="text" id="trigger_exposure" name="trigger_exposure"
                            placeholder="Procedure, Drug, Device" required>
                    </div>
                    <div>
                        <label for="timing">E. Timing</label>
                        <input type="text" id="timing" name="timing" placeholder="Intra-op phase, Post-op day X"
                            required>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label for="host_factors">F. Host Factors</label>
                        <textarea id="host_factors" name="host_factors" rows="3"
                            placeholder="Age, Comorbidities, Genetics..."></textarea>
                    </div>
                    <div>
                        <label for="key_findings">G. Key Findings</label>
                        <textarea id="key_findings" name="key_findings" rows="3"
                            placeholder="Imaging, Pathology, Labs..."></textarea>
                    </div>
                </div>

                <div>
                    <label for="management_outcome">H. Management / Outcome</label>
                    <textarea id="management_outcome" name="management_outcome" rows="2"
                        placeholder="Intervention & Outcome"></textarea>
                </div>

                <div>
                    <label for="novelty_differences">I. Novelty / Differences</label>
                    <textarea id="novelty_differences" name="novelty_differences" rows="3"
                        placeholder="Why is this new?" required></textarea>
                </div>

                <div class="submit-section">
                    <button type="submit" class="btn btn-primary" id="analyzeBtn">
                        <span id="btnText">Analyze & Send Report</span>
                        <span id="spinner" class="loading-spinner" style="display:none;"></span>
                    </button>

                    <div class="info-box" style="margin-bottom: 1rem;">
                        <p><strong>Checklist入力説明</strong></p>
                        <ul style="list-style: none; padding-left: 0;">
                            <li><strong>A. Main Event：</strong>具体的に（Timing/Trigger/Anatomyを盛り込んで）一文で</li>
                            <li><strong>B. Condition/Event：</strong>何が起きたか簡潔に一文で</li>
                            <li><strong>C. Anatomy：</strong>部位・左右・関連構造</li>
                            <li><strong>D. Trigger/Exposure：</strong>誘因（手技、デバイス、薬剤、感染、外傷、妊娠など）</li>
                            <li><strong>E. Timing：</strong>いつ（術中/術後POD、投与後何分、妊娠週数など）</li>
                            <li><strong>F. Host factors：</strong>宿主要因（基礎疾患、遺伝素因、解剖学的特徴、免疫抑制、妊娠、腎不全など）</li>
                            <li><strong>G. Key Findings：</strong>決め手になった所見（画像、術中所見、病理、バイオマーカー、合併症パターン）</li>
                            <li><strong>H. Management/Outcome：</strong>介入（手技・薬剤・周術期管理）と転帰（短期/長期、再発、合併症）</li>
                        </ul>
                    </div>

                    <div class="info-box">
                        <p><strong>Novelty score（0–100）は、最も一致度の高い既報の CATTO Level に基づいて算出しました：</strong></p>
                        <ul>
                            <li>• Level 4 既報多い → ≤20%</li>
                            <li>• Level 3 やや既報あり(さらなる差を見つける) → 30–50%</li>
                            <li>• Level 2 少しの既報のみ(症例報告いけるかも) → 60–80%</li>
                            <li>• Level 1 のみ／未一致(論文までいけそう) → ≥85%</li>
                        </ul>
                    </div>
                </div>

            </form>
        </section>

        <section id="results" class="glass-panel" style="display:none; margin-top: 2rem;">
            <h2 style="text-align: center;">
                Novelty Score: <span id="scoreValue" style="color: var(--secondary);">--</span>%
            </h2>
            <div style="text-align: center; margin-bottom: 1rem;">
                <span id="judgementBadge" class="badge">-- Priority</span>
            </div>

            <details class="info-box" style="margin-bottom: 1rem;">
                <summary style="cursor: pointer; font-weight: bold;">Step 1: Reconstructed CATTO</summary>
                <pre id="reconstructedCatto"
                    style="white-space: pre-wrap; font-size: 0.85rem; margin-top: 0.5rem;"></pre>
            </details>

            <details class="info-box" style="margin-bottom: 1rem;">
                <summary style="cursor: pointer; font-weight: bold;">Step 2: Search Core</summary>
                <pre id="searchCore" style="white-space: pre-wrap; font-size: 0.85rem; margin-top: 0.5rem;"></pre>
            </details>

            <div id="resultContent"></div>
        </section>
    </div>

    <script type="module" src="app.js"></script>
</body>

</html>